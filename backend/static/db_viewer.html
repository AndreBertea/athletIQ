<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualiseur de Bases de Donn√©es - Athl√©tIQ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .db-section {
            margin-bottom: 40px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
        }

        .db-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .db-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }

        .db-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .db-content {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .table-section {
            margin-top: 20px;
        }

        .table-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e1e5e9;
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÉ‚Äç‚ôÇÔ∏è Athl√©tIQ</h1>
            <p>Visualiseur de Bases de Donn√©es</p>
        </div>

        <div class="content">
            <!-- Base de donn√©es principale -->
            <div class="db-section">
                <div class="db-header">
                    <div class="db-title">üìä Base de Donn√©es Principale (stridelta.db)</div>
                    <div class="db-status status-active" id="main-db-status">Active</div>
                </div>
                <div class="db-content">
                    <div class="stats-grid" id="main-db-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="main-users">-</div>
                            <div class="stat-label">Utilisateurs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="main-activities">-</div>
                            <div class="stat-label">Activit√©s</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="main-plans">-</div>
                            <div class="stat-label">Plans d'entra√Ænement</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="main-auth">-</div>
                            <div class="stat-label">Connexions OAuth</div>
                        </div>
                    </div>

                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('main', 'users')">Utilisateurs</div>
                        <div class="tab" onclick="switchTab('main', 'activities')">Activit√©s</div>
                        <div class="tab" onclick="switchTab('main', 'plans')">Plans</div>
                        <div class="tab" onclick="switchTab('main', 'auth')">Authentification</div>
                    </div>

                    <div id="main-users-content" class="tab-content active">
                        <div class="table-section">
                            <div class="table-title">Utilisateurs</div>
                            <table class="data-table" id="main-users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Email</th>
                                        <th>Nom</th>
                                        <th>Cr√©√© le</th>
                                    </tr>
                                </thead>
                                <tbody id="main-users-tbody">
                                    <tr><td colspan="4" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="main-activities-content" class="tab-content">
                        <div class="table-section">
                            <div class="table-title">Activit√©s</div>
                            <table class="data-table" id="main-activities-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nom</th>
                                        <th>Type</th>
                                        <th>Distance</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="main-activities-tbody">
                                    <tr><td colspan="5" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="main-plans-content" class="tab-content">
                        <div class="table-section">
                            <div class="table-title">Plans d'Entra√Ænement</div>
                            <table class="data-table" id="main-plans-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nom</th>
                                        <th>Type</th>
                                        <th>Distance</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="main-plans-tbody">
                                    <tr><td colspan="5" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="main-auth-content" class="tab-content">
                        <div class="table-section">
                            <div class="table-title">Connexions OAuth</div>
                            <table class="data-table" id="main-auth-table">
                                <thead>
                                    <tr>
                                        <th>User ID</th>
                                        <th>Type</th>
                                        <th>Access Token</th>
                                        <th>Expires</th>
                                    </tr>
                                </thead>
                                <tbody id="main-auth-tbody">
                                    <tr><td colspan="4" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Base de donn√©es enrichie -->
            <div class="db-section">
                <div class="db-header">
                    <div class="db-title">üîç Base de Donn√©es Enrichie (activity_detail.db)</div>
                    <div class="db-status status-active" id="enriched-db-status">Active</div>
                </div>
                <div class="db-content">
                    <div class="stats-grid" id="enriched-db-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="enriched-activities">-</div>
                            <div class="stat-label">Activit√©s Enrichies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="enriched-sports">-</div>
                            <div class="stat-label">Types de Sport</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="enriched-distance">-</div>
                            <div class="stat-label">Distance Totale (km)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="enriched-time">-</div>
                            <div class="stat-label">Temps Total (h)</div>
                        </div>
                    </div>

                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('enriched', 'activities')">Activit√©s</div>
                        <div class="tab" onclick="switchTab('enriched', 'sports')">Types de Sport</div>
                        <div class="tab" onclick="switchTab('enriched', 'stats')">Statistiques</div>
                    </div>

                    <div id="enriched-activities-content" class="tab-content active">
                        <div class="table-section">
                            <div class="table-title">Activit√©s Enrichies</div>
                            <table class="data-table" id="enriched-activities-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nom</th>
                                        <th>Type</th>
                                        <th>Distance (km)</th>
                                        <th>Temps (min)</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="enriched-activities-tbody">
                                    <tr><td colspan="6" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="enriched-sports-content" class="tab-content">
                        <div class="table-section">
                            <div class="table-title">R√©partition par Type de Sport</div>
                            <table class="data-table" id="enriched-sports-table">
                                <thead>
                                    <tr>
                                        <th>Type de Sport</th>
                                        <th>Nombre d'Activit√©s</th>
                                        <th>Distance Totale (km)</th>
                                        <th>Temps Total (h)</th>
                                    </tr>
                                </thead>
                                <tbody id="enriched-sports-tbody">
                                    <tr><td colspan="4" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="enriched-stats-content" class="tab-content">
                        <div class="table-section">
                            <div class="table-title">Statistiques D√©taill√©es</div>
                            <table class="data-table" id="enriched-stats-table">
                                <thead>
                                    <tr>
                                        <th>M√©trique</th>
                                        <th>Valeur</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody id="enriched-stats-tbody">
                                    <tr><td colspan="3" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bouton de rafra√Æchissement -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="refresh-btn" onclick="loadAllData()">üîÑ Rafra√Æchir les Donn√©es</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentMainTab = 'users';
        let currentEnrichedTab = 'activities';

        // Fonction pour changer d'onglet
        function switchTab(db, tab) {
            if (db === 'main') {
                // Masquer tous les contenus principaux
                document.querySelectorAll('#main-users-content, #main-activities-content, #main-plans-content, #main-auth-content').forEach(el => {
                    el.classList.remove('active');
                });
                // Masquer tous les onglets principaux
                document.querySelectorAll('.db-section:first-child .tab').forEach(el => {
                    el.classList.remove('active');
                });
                // Afficher le contenu s√©lectionn√©
                document.getElementById(`main-${tab}-content`).classList.add('active');
                // Activer l'onglet s√©lectionn√©
                event.target.classList.add('active');
                currentMainTab = tab;
            } else if (db === 'enriched') {
                // Masquer tous les contenus enrichis
                document.querySelectorAll('#enriched-activities-content, #enriched-sports-content, #enriched-stats-content').forEach(el => {
                    el.classList.remove('active');
                });
                // Masquer tous les onglets enrichis
                document.querySelectorAll('.db-section:last-child .tab').forEach(el => {
                    el.classList.remove('active');
                });
                // Afficher le contenu s√©lectionn√©
                document.getElementById(`enriched-${tab}-content`).classList.add('active');
                // Activer l'onglet s√©lectionn√©
                event.target.classList.add('active');
                currentEnrichedTab = tab;
            }
        }

        // Fonction pour formater les donn√©es
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDistance(meters) {
            if (!meters) return '-';
            return (meters / 1000).toFixed(2) + ' km';
        }

        function formatTime(seconds) {
            if (!seconds) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h${minutes.toString().padStart(2, '0')}`;
        }

        function formatToken(token) {
            if (!token) return '-';
            return token.substring(0, 10) + '...';
        }

        // Fonction pour charger les donn√©es principales
        async function loadMainData() {
            try {
                // Charger les statistiques
                const statsResponse = await fetch('/api/v1/activities/stats?period_days=365');
                const stats = await statsResponse.json();
                
                document.getElementById('main-activities').textContent = stats.total_activities || 0;
                
                // Charger les utilisateurs
                const usersResponse = await fetch('/api/v1/auth/users');
                const users = await usersResponse.json();
                document.getElementById('main-users').textContent = users.length || 0;
                
                // Charger les plans d'entra√Ænement
                const plansResponse = await fetch('/api/v1/workout-plans');
                const plans = await plansResponse.json();
                document.getElementById('main-plans').textContent = plans.length || 0;
                
                // Charger les donn√©es OAuth
                const authResponse = await fetch('/api/v1/auth/oauth-status');
                const auth = await authResponse.json();
                document.getElementById('main-auth').textContent = (auth.strava_connected ? 1 : 0) + (auth.google_connected ? 1 : 0);
                
                // Remplir les tableaux
                fillUsersTable(users);
                fillActivitiesTable(stats.activities || []);
                fillPlansTable(plans);
                fillAuthTable(auth);
                
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es principales:', error);
                document.getElementById('main-db-status').textContent = 'Erreur';
                document.getElementById('main-db-status').className = 'db-status status-inactive';
            }
        }

        // Fonction pour charger les donn√©es enrichies
        async function loadEnrichedData() {
            try {
                // Charger les statistiques enrichies
                const statsResponse = await fetch('/api/v1/activities/enriched/stats?period_days=365');
                const stats = await statsResponse.json();
                
                document.getElementById('enriched-activities').textContent = stats.total_activities || 0;
                document.getElementById('enriched-distance').textContent = (stats.total_distance_km || 0).toFixed(1);
                document.getElementById('enriched-time').textContent = (stats.total_time_hours || 0).toFixed(1);
                
                // Compter les types de sport
                const sportsCount = Object.keys(stats.activities_by_sport_type || {}).length;
                document.getElementById('enriched-sports').textContent = sportsCount;
                
                // Charger les activit√©s enrichies
                const activitiesResponse = await fetch('/api/v1/activities/enriched?limit=50');
                const activities = await activitiesResponse.json();
                
                // Remplir les tableaux
                fillEnrichedActivitiesTable(activities);
                fillEnrichedSportsTable(stats);
                fillEnrichedStatsTable(stats);
                
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es enrichies:', error);
                document.getElementById('enriched-db-status').textContent = 'Erreur';
                document.getElementById('enriched-db-status').className = 'db-status status-inactive';
            }
        }

        // Fonctions pour remplir les tableaux
        function fillUsersTable(users) {
            const tbody = document.getElementById('main-users-tbody');
            tbody.innerHTML = '';
            
            users.slice(0, 10).forEach(user => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${user.id || '-'}</td>
                    <td>${user.email || '-'}</td>
                    <td>${user.name || '-'}</td>
                    <td>${formatDate(user.created_at)}</td>
                `;
            });
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Aucun utilisateur trouv√©</td></tr>';
            }
        }

        function fillActivitiesTable(activities) {
            const tbody = document.getElementById('main-activities-tbody');
            tbody.innerHTML = '';
            
            activities.slice(0, 10).forEach(activity => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${activity.id || '-'}</td>
                    <td>${activity.name || '-'}</td>
                    <td>${activity.activity_type || '-'}</td>
                    <td>${formatDistance(activity.distance)}</td>
                    <td>${formatDate(activity.start_date)}</td>
                `;
            });
            
            if (activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Aucune activit√© trouv√©e</td></tr>';
            }
        }

        function fillPlansTable(plans) {
            const tbody = document.getElementById('main-plans-tbody');
            tbody.innerHTML = '';
            
            plans.slice(0, 10).forEach(plan => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${plan.id || '-'}</td>
                    <td>${plan.name || '-'}</td>
                    <td>${plan.workout_type || '-'}</td>
                    <td>${plan.planned_distance || 0} km</td>
                    <td>${formatDate(plan.planned_date)}</td>
                `;
            });
            
            if (plans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Aucun plan trouv√©</td></tr>';
            }
        }

        function fillAuthTable(auth) {
            const tbody = document.getElementById('main-auth-tbody');
            tbody.innerHTML = '';
            
            const authData = [];
            if (auth.strava_connected) {
                authData.push({
                    user_id: auth.user_id,
                    type: 'Strava',
                    access_token: auth.strava_access_token,
                    expires: auth.strava_expires_at
                });
            }
            if (auth.google_connected) {
                authData.push({
                    user_id: auth.user_id,
                    type: 'Google',
                    access_token: auth.google_access_token,
                    expires: auth.google_expires_at
                });
            }
            
            authData.forEach(authItem => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${authItem.user_id || '-'}</td>
                    <td>${authItem.type}</td>
                    <td>${formatToken(authItem.access_token)}</td>
                    <td>${formatDate(authItem.expires)}</td>
                `;
            });
            
            if (authData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Aucune connexion OAuth trouv√©e</td></tr>';
            }
        }

        function fillEnrichedActivitiesTable(activities) {
            const tbody = document.getElementById('enriched-activities-tbody');
            tbody.innerHTML = '';
            
            activities.slice(0, 10).forEach(activity => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${activity.activity_id || '-'}</td>
                    <td>${activity.name || '-'}</td>
                    <td>${activity.sport_type || '-'}</td>
                    <td>${formatDistance(activity.distance_m)}</td>
                    <td>${formatTime(activity.moving_time_s)}</td>
                    <td>${formatDate(activity.start_date_utc)}</td>
                `;
            });
            
            if (activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Aucune activit√© enrichie trouv√©e</td></tr>';
            }
        }

        function fillEnrichedSportsTable(stats) {
            const tbody = document.getElementById('enriched-sports-tbody');
            tbody.innerHTML = '';
            
            const sports = stats.activities_by_sport_type || {};
            Object.entries(sports).forEach(([sport, count]) => {
                const row = tbody.insertRow();
                const distance = stats.distance_by_sport_type?.[sport] || 0;
                const time = stats.time_by_sport_type?.[sport] || 0;
                row.innerHTML = `
                    <td>${sport}</td>
                    <td>${count}</td>
                    <td>${(distance / 1000).toFixed(1)} km</td>
                    <td>${(time / 3600).toFixed(1)} h</td>
                `;
            });
            
            if (Object.keys(sports).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Aucun type de sport trouv√©</td></tr>';
            }
        }

        function fillEnrichedStatsTable(stats) {
            const tbody = document.getElementById('enriched-stats-tbody');
            tbody.innerHTML = '';
            
            const statsData = [
                { metric: 'Total Activit√©s', value: stats.total_activities || 0, description: 'Nombre total d\'activit√©s enrichies' },
                { metric: 'Distance Totale', value: `${(stats.total_distance_km || 0).toFixed(1)} km`, description: 'Distance totale parcourue' },
                { metric: 'Temps Total', value: `${(stats.total_time_hours || 0).toFixed(1)} h`, description: 'Temps total d\'activit√©' },
                { metric: 'Types de Sport', value: Object.keys(stats.activities_by_sport_type || {}).length, description: 'Nombre de types de sport diff√©rents' },
                { metric: 'Pace Moyen', value: `${(stats.average_pace_by_sport?.Run || 0).toFixed(1)} min/km`, description: 'Pace moyen pour la course √† pied' }
            ];
            
            statsData.forEach(stat => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${stat.metric}</td>
                    <td>${stat.value}</td>
                    <td>${stat.description}</td>
                `;
            });
        }

        // Fonction principale pour charger toutes les donn√©es
        async function loadAllData() {
            await Promise.all([
                loadMainData(),
                loadEnrichedData()
            ]);
        }

        // Charger les donn√©es au d√©marrage
        document.addEventListener('DOMContentLoaded', loadAllData);
    </script>
</body>
</html> 